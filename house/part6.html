<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Blog about declarative home automation, smart home systems, and avoiding vendor lock-in with Nix-based solutions">
    <meta property="og:title" content="Declarative Home Automation with Nix">
    <meta property="og:description" content="Learn how to define your smart home devices and avoid vendor lock-in">
    <meta property="og:type" content="article">
    <meta name="twitter:card" content="summary_large_image">
    <title>ü¶Üüßë‚Äçü¶Ø'blog</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .gallery {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }
        .gallery img {
            width: 25%;
            min-width: 200px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        .gallery img:hover {
            transform: scale(1.03);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .lightbox {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            animation: fadeIn 0.3s;
        }
        .lightbox-content {
            display: block;
            margin: auto;
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .lightbox-caption {
            text-align: center;
            color: #fff;
            padding: 10px 0;
            font-size: 1.2em;
        }
        .close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }
        .close:hover {
            color: #bbb;
        }
        .prev, .next {
            cursor: pointer;
            position: absolute;
            top: 50%;
            width: auto;
            padding: 16px;
            margin-top: -50px;
            color: white;
            font-weight: bold;
            font-size: 30px;
            transition: 0.3s;
            user-select: none;
            background-color: rgba(0,0,0,0.3);
            border-radius: 0 5px 5px 0;
        }
        .next {
            right: 0;
            border-radius: 5px 0 0 5px;
        }
        .prev:hover, .next:hover {
            background-color: rgba(0,0,0,0.8);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        video {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>

    <div class="navbar">
        <div class="navbar-content">
            <a href="https://github.com/QuackHack-McBlindy" title="GitHub">
                <img src="../img/github_teal.png" alt="GitHub" class="github-icon" style="height: 32px;" onmouseover="this.src='../img/github_magenta.png';" onmouseout="this.src='../img/github_teal.png';"> </img>
            </a>
            
            <div class="navbar-title">
                <span>ü¶Ü</span>üßë‚Äçü¶Ø <a href="https://quackhack-mcblindy.github.io/blog/">QuackHack-McBlindy blog</a>
            </div>
            <img src="../img/logo.png" height="48" width="48" >
            <button id="duckToggle" class="toggle-btn" aria-label="Toggle duck commentary">

                <span class="duck-icon">ü¶Ü</span>
                Hide duck commentary
            </button>
        </div>
    </div>
    

    <div class="toc-container">
        <details class="toc-details">
            <summary class="toc-header">
                <span class="toc-duck">ü¶Ü</span>
                <h3>Navigation</h3>
                <span class="toc-man">üßë‚Äçü¶Ø</span>
                <span class="toc-toggle">‚Æü</span>
            </summary>
            <nav class="toc-nav">
                <a href="../yo/index.html" class="toc-item">
                    <span class="toc-icon">ü´Ä</span>
                    Yo - Define & Unify
                </a>
                <a href="../do/index.html" class="toc-item">
                    <span class="toc-icon">üß†</span>
                    Do - Listen, Process, Act & Learn
                </a>
                <a href="index.html" class="toc-item current">
                    <span class="toc-icon">üè†</span>
                    House - Declarative Home Automation
                    <span class="current-marker">‚Æúü¶Ü</span>
                </a>
                <a href="../docs/index.html" class="toc-item">
                    <span class="toc-icon">üìö</span>
                    Documentation - Automating the README
                </a>
                <a href="../misc/index.html" class="toc-item">
                    <span class="toc-icon">üß©</span>
                    Miscellaneous 
                </a>
            </nav>
            <div class="toc-footer">
                <span class="toc-quack">ü¶Ü says ‚Æû qwack qwack, plx pick!</span>
            </div>
        </details>
    </div>
    
  
    <div class="content">
        <header class="category-title">
            <h1>Defining Your Home</h1>
            <p class="subtitle"> Part 6 - The Automatically Generated Dashboard</p>
        </header>

        
        <div class="duck-comment">
            <p>says ‚Æû I use 20x magnification when I code and debug. I use emoji to simplify logs for myself. If you can't handle my code style you can disable most of it on this website by toggling the button in the navbar. Shall duck continue? </p>
        </div>

        <h2 class="section-title">Contribute</h2>
        I'm not really an dashboard kind of guy, but I understand it can have great uses on phone when away.<br>
        If you feel like this dashboard is insufficient, feel free to contribute.<br> 


        <h2 class="section-title">Automagi Dashboard</h2>
        <br>This is all automatically generated.<br>
        Connected to Mosquitto over WebSockets.<br>
        The gradient image for each scene is dynamically fetched from every device's color in the scene.<br>
        I think that's my favourite feature in this slimmed dashboard.<br>
        <br><br>
        It also let's you control defined TV's through a remote page.<br>
        <br>


        <h2 class="section-title">Gallery & Video</h2>
        <br>
     
        <div class="gallery">
            <img src="https://raw.githubusercontent.com/QuackHack-McBlindy/dotfiles/main/home/duckdash1.png" alt="DuckDash 1" onclick="openLightbox(0)">
            <img src="https://raw.githubusercontent.com/QuackHack-McBlindy/dotfiles/main/home/duckdash2.png" alt="DuckDash 2" onclick="openLightbox(1)"><br>
            <img src="https://raw.githubusercontent.com/QuackHack-McBlindy/dotfiles/main/home/duckdash3.png" alt="DuckDash 3" onclick="openLightbox(2)">
            <img src="https://raw.githubusercontent.com/QuackHack-McBlindy/dotfiles/main/home/duckdash4.png" alt="DuckDash 4" onclick="openLightbox(3)"><br>
            <img src="https://raw.githubusercontent.com/QuackHack-McBlindy/dotfiles/main/home/duckdash5.png" alt="DuckDash 4" onclick="openLightbox(3)"><br>
            <video width="600" controls>
                <source src="https://raw.githubusercontent.com/QuackHack-McBlindy/dotfiles/main/home/duckdash.mp4" type="video/mp4">
                Your browser does not support the video tag.
            </video>

        </div><br>
        <br><br>
        
        <div id="lightbox" class="lightbox">
            <span class="close" onclick="closeLightbox()">&times;</span>
            <span class="prev" onclick="changeImage(-1)">&#10094;</span>
            <span class="next" onclick="changeImage(1)">&#10095;</span>
            <div id="lightbox-content-container">
                <img class="lightbox-content" id="lightbox-img">
                <div id="lightbox-loading" class="loading" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
            </div>
            <div class="lightbox-caption" id="lightbox-caption"></div>
        </div>


            <div class="duck-comment">
                <p>
                    ‚Æû <i>if any JS yoda wanna help out...</i> 
                </p>
            </div><br>     
            
            
        <h2 class="section-title">Customizing The Dashboard</h2>
        
        The dashboard is extremely modular in the sense that extending it with more pages is as easy as:<br>

        <details class="code-block-container" style="margin-bottom: 1em;" open>
          <summary class="code-header">
              <div class="code-lang">‚Æû View Weather Page Example</div>
          </summary>
              <div class="code-block">
                <pre><span class="duck-version">
  house = {
    dashboard = {
      pages = {
        "4" = {
          icon = "fas fa-cloud-sun";
          title = "Weather";
          code = ''
            hello world
          '';
        };
      };
    };  
  
  };}
</span><span class="clean-version hidden">
  house = {
    dashboard = {
      pages = {
        "4" = {
          icon = "fas fa-cloud-sun";
          title = "Weather";
          code = ''
            hello world
          '';
        };
      };
    };  
  
  };}
</span></pre>
            </div>
        </div>
    </details>        
        
        
        
        
        <h2 class="section-title">Status Cards</h2>        
        
        The dashboard only comes with one built-in status card, which displays the temperature from your sensors.<br>   
        <br>Here I am going to show you how easy it is to configure custom status cards for the home page of the dashboard.<br>
        <br>
        For simplicity let's assume you have a energy price script - which data you'd like to publish and display as a status card.<br>
        Let's say it looks something like this:
        
        
        
        <details class="code-block-container" style="margin-bottom: 1em;" open>
          <summary class="code-header">
              <div class="code-lang">‚Æû View Message Processing Handler</div>
          </summary>
              <div class="code-block">
                <pre><span class="duck-version">
mqtt_publish \
  -h 192.168.1.111 \ # ü¶Üsays‚Æû MQTT broker IP
  -u mqtt \ # ü¶Üsays‚Æû MQTT user
  -p "$(cat /run/secrets/mosquitto)" \ # ü¶Üsays‚Æû password file
  -t zigbee2mqtt/energy \ # ü¶Üsays‚Æû MQTT topic
  # ü¶Üsays‚Æû MQTT message with variable containing the price & usage data
  -m "{\"current_price\": \"$TOTAL\", \"monthly_usage\": \"$TOTAL_KWH\"}"
</span><span class="clean-version hidden">
mqtt_publish \
  -h 192.168.1.111 \
  -u mqtt \
  -p "$(cat /run/secrets/mosquitto)" \
  -t zigbee2mqtt/energy \
  -m "{\"current_price\": \"$TOTAL\", \"monthly_usage\": \"$TOTAL_KWH\"}"
</span></pre>
            </div>
        </div>
    </details>        

        Now the easiest way of getting that displayed on the dashboard is to use what we already have - Nix automations!<br>
        First let's create a mqtt_triggered automation:<br>
        
        
        <details class="code-block-container" style="margin-bottom: 1em;" open>
          <summary class="code-header">
              <div class="code-lang">‚Æû View Message Processing Handler</div>
          </summary>
              <div class="code-block">
                <pre><span class="duck-version">
{ # ü¶Ü says ‚Æû my house - qwack 
  config,
  lib,
  pkgs,
  ...
} : let
in { # ü¶Ü duck say ‚Æû qwack
  house = {
    zigbee = {
      automations = { 
        mqtt_triggered = {
          energy = {
            enable = true;
            description = "Writes energy data to file for dashboard";
            topic = "zigbee2mqtt/energy";
            actions = [
              {
                type = "shell";
                command = ''
                  touch /var/lib/zigduck/energy.json
                  echo "$MQTT_PAYLOAD" > /var/lib/zigduck/energy.json
                '';
              }
            ];
          };     
        };
      };
    };
  
  };}
</span><span class="clean-version hidden">
{
  config,
  lib,
  pkgs,
  ...
} : let
in {
  house = {
    zigbee = {
      automations = { 
        mqtt_triggered = {
          energy = {
            enable = true;
            description = "Writes energy data to file for dashboard";
            topic = "zigbee2mqtt/energy";
            actions = [
              {
                type = "shell";
                command = ''
                  touch /var/lib/zigduck/energy.json
                  echo "$MQTT_PAYLOAD" > /var/lib/zigduck/energy.json
                '';
              }
            ];
          };     
        };
      };
    };
  
  };}
</span></pre>
            </div>
        </div>
    </details>                   
        

        This simply creates a file containing the mqtt message and saves it as '/var/lib/zigduck/energy.json'.<br>
        Basic stuff huh? Let's move on to step two, which is the last and final step.<br>
        We're creating a Nix configured status card that reads the file content.<br>
        

        <details class="code-block-container" style="margin-bottom: 1em;" open>
          <summary class="code-header">
              <div class="code-lang">‚Æû View Message Processing Handler</div>
          </summary>
              <div class="code-block">
                <pre><span class="duck-version">
{ # ü¶Ü says ‚Æû my house - qwack 
  config,
  lib,
  pkgs,
  ...
} : let
in { # ü¶Ü says ‚Æû qwack
  house = {
    dashboard = {
      statusCards = {
        energy = { # ü¶Üsays‚Æû name of card
          enable = true;
          title = "Energy"; # ü¶Üsays‚Æû title that is displayed inside the card
          # ü¶Üsays‚Æû Font Awesome icon library https://fontawesome.com/icons
          icon = "fas fa-dollar";
          color = "#2196f3"; # ü¶Üsays‚Æû HEX color for the icon
          filePath = "/var/lib/zigduck/energy.json"; # ü¶Üsays‚Æû file path to read data from
          # ü¶Üsays‚Æû since our script had this json field - we read this specific field
          jsonField = "current_price"; 
          # ü¶Üsays‚Æû format output. {value} is the value of the field we specified above - and i want to display it in SEK/kWh
          format = "{value} SEK/kWh";
          # details = "Current price"; # ü¶Üsays‚Æû static footer of the card
          # ü¶Üsays‚Æû or we can read another json field
          detailsJsonField = "monthly_usage";
          detailsFormat = "Usage: {value} kWh";
        };
      };
    };
    
  };}
</span><span class="clean-version hidden">
{
  config,
  lib,
  pkgs,
  ...
} : let
in {
  house = {
    dashboard = {
      statusCards = {
        energy = {
          enable = true;
          title = "Energy";
          icon = "fas fa-dollar"; # Font Awesome icon library https://fontawesome.com/icons
          color = "#2196f3";
          filePath = "/var/lib/zigduck/energy_price.json";
          jsonField = "current_price";
          format = "{value} SEK/kWh";
          # details = "Current price";
          detailsJsonField = "monthly_usage";
          detailsFormat = "Usage: {value} kWh";
        };
      };
    };
      
  };}
</span></pre>
            </div>
        </div>
    </details>            

        <br>
        Give the card a name, title, icon - choose a file path to read json data from, define the key of the data you want to display and you format the output, where <strong>{value}</strong> show's the actual data.<br>
        You can either set a static footer <i>(details)</i> or choose to read another json field from the same file.<br>
        This creates a status card that looks like this:<br><br>
        <img src="../img/card.jpeg" height="200ppx" width="400px">
        <br>




        <div class="duck-comment">
            <p>‚Æû and dat iz it yo! no qwackin' way dat was hard?? </p>
        </div>        


        Keep adding as many cards as you'd like.<br>
        These are the only configurable options for this dashboard as of now, but they do offer good flexibility.<br>
        If you have configured everything from earlier steps everything should <i>just work</i>.<br>
        <br><br>
        
        <h2 class="section-title">Example page</h2>                
        
        Let's create a service for all our hosts that will ruun a health check every 15th minute and report to our dashboard through a Nix automation.<br>
        
        <details class="code-block-container" style="margin-bottom: 1em;">
          <summary class="code-header">
              <div class="code-lang">‚Æû View System Monitoring Dashboard Page</div>
          </summary>
              <div class="code-block">
                <pre><span class="duck-version">        
{ # ü¶Ü says ‚Æû health checks for all hosts automated into dashboard  
  self,
  lib,
  config,
  pkgs,
  cmdHelpers,
  ... 
} : let   
  # ü¶Ü says ‚Æû dis fetch what host has Mosquitto
  sysHosts = lib.attrNames self.nixosConfigurations; 
  mqttHost = lib.findSingle (host:
      let cfg = self.nixosConfigurations.${host}.config;
      in cfg.services.mosquitto.enable or false
    ) null null sysHosts;    
  mqttHostip = if mqttHost != null
    then self.nixosConfigurations.${mqttHost}.config.this.host.ip or (
      let
        resolved = builtins.readFile (pkgs.runCommand "resolve-host" {} ''
          ${pkgs.dnsutils}/bin/host -t A ${mqttHost} > $out
        '');
      in
        lib.lists.head (lib.strings.splitString " " (lib.lists.elemAt (lib.strings.splitString "\n" resolved) 0))
    )
    else (throw "No Mosquitto host found in configuration");

  environment.systemPackages = [  ];  
  pyEnv = pkgs.python3.withPackages (ps: [ ps.psutil ]); 
  

  pyCheck = pkgs.writeScript "pyCheck.py" ''
    #!${pyEnv}/bin/python   
    import subprocess
    import psutil
    import sys
    import time
    import socket
    import os
    import json
    import re
    from datetime import timedelta
    import logging
    
    logging.basicConfig(level=logging.INFO)
    logger = logging.getLogger(__name__)
    
    def get_disk_temperature(disk: str):
        try:
            if disk.startswith('/dev/nvme'):
                cmd = ['sudo', 'nvme', 'smart-log', disk]
                result = subprocess.run(cmd,
                                      stdout=subprocess.PIPE,
                                      stderr=subprocess.PIPE,
                                      text=True,
                                      timeout=5)
                
                if result.returncode != 0:
                    return "failed"
                
                match = re.search(r'Temperature Sensor 1\s*:\s*(\d+)\s*¬∞C', result.stdout)
                return f"{match.group(1)}¬∞C" if match else "N/A"
            
            else:
                cmd = ['sudo', 'smartctl', '-a', disk]
                result = subprocess.run(cmd,
                                      stdout=subprocess.PIPE,
                                      stderr=subprocess.PIPE,
                                      text=True,
                                      timeout=5)
                
                if result.returncode != 0:
                    return "failed"
                
                for line in result.stdout.split('\n'):
                    if 'Temperature_Celsius' in line:
                        parts = line.split()
                        return f"{parts[9]}¬∞C" if len(parts) >= 10 else "N/A"
                return "N/A"
                
        except Exception as e:
            logger.error(f"Temperature error: {str(e)}")
            return "failed"
    
    def get_system_stats():
        stats = {
            "hostname": socket.gethostname(),
            "uptime": str(timedelta(seconds=time.time() - psutil.boot_time())),
            "cpu_usage": psutil.cpu_percent(interval=1),
            "cpu_temperature": "N/A",
            "memory_usage": psutil.virtual_memory().percent,
            "disk_usage": {},
            "disk_temperature": {}
        }
    
        try:
            temps = psutil.sensors_temperatures()
            if 'coretemp' in temps:
                stats["cpu_temperature"] = f"{temps['coretemp'][0].current}¬∞C"
        except Exception as e:
            logger.error(f"CPU temp error: {e}")
    
        disk_temp_cache = {}
        partitions = psutil.disk_partitions()
        
        lsblk_output = subprocess.check_output(
            ['lsblk', '-d', '-n', '-o', 'NAME'],
            text=True
        )
        physical_disks = [f"/dev/{line.strip()}" for line in lsblk_output.split('\n') if line]
    
        for disk in physical_disks:
            disk_temp_cache[disk] = get_disk_temperature(disk)
    
        shown_disks = set()
        for partition in partitions:
            try:
                stats["disk_usage"][partition.device] = f"{psutil.disk_usage(partition.mountpoint).percent}%"
                
                real_device = os.path.realpath(partition.device)
                parent = subprocess.check_output(
                    ['lsblk', '-no', 'pkname', real_device],
                    text=True
                ).strip()
                
                if parent:
                    parent_disk = f"/dev/{parent}"
                    if parent_disk not in shown_disks:
                        stats["disk_temperature"][parent_disk] = disk_temp_cache.get(parent_disk, "N/A")
                        shown_disks.add(parent_disk)
    
            except Exception as e:
                logger.error(f"Disk error: {e}")
                continue
    
        return stats
    
    if __name__ == "__main__":
        print(json.dumps(get_system_stats(), indent=4))
  '';   

  security.sudo.extraRules = [  
    {
      users = [ config.this.user.me.name ];
      commands = [
        {
          command = ${pyCheck};
          options = [ "NOPASSWD" ];
        }
      ];
    }  
  ];
  
  health = lib.mapAttrs (hostName: _: {
    enable = true;
    description = "Health Check: ${hostName}";
    topic = "zigbee2mqtt/health/${hostName}";
    actions = [
      {
         type = "shell";
         command = ''
           mkdir -p /var/lib/zigduck/health
           touch /var/lib/zigduck/health/${hostName}.json
           echo "$MQTT_PAYLOAD" > /var/lib/zigduck/health/${hostName}.json
        '';
       }
     ];
  }) self.nixosConfigurations;
    
in {   
  services.udev.packages = [ pkgs.nvme-cli pkgs.smartmontools ];
  environment.systemPackages = with pkgs; [ nvme-cli smartmontools util-linux ];
   
  yo.scripts.health = {
    description = "Health check and reporting across your machines. Returns JSON structured responses.";
    category = "üßπ Maintenance";  
    aliases = [ "hc" ];
    runEvery = "15"; # ü¶Ü15min
    code = ''
      ${cmdHelpers}            
      MQTT_BROKER="${mqttHostip}"
      MQTT_USER="${config.house.zigbee.mosquitto.username}"
      MQTT_PASSWORD=$(cat "${config.house.zigbee.mosquitto.passwordFile}")
      HC="$(sudo ${pyCheck})"
      mqtt_pub -t "zigbee2mqtt/health/${config.this.host.hostname}" -m "$HC"
    ''; 
  };

  house = {
    # ü¶Ü says ‚Æû DASHBOARD CONFIOGURATION 
    dashboard = {
      pages = {
        "4" = {
          icon = "fas fa-notes-medical";
          title = "health";
          files = { health = "/var/lib/zigduck/health"; };
          css = ''
            .health-page .container,
            .health-page .content,
            .health-page > div {
              width: 100% !important;
              max-width: 100% !important;
              margin: 0 !important;
              padding: 0 !important;
            }
            .page[data-page] {
              width: 100% !important;
              max-width: 100% !important;
            }
            .health-page {
              max-width: 1200px;
              margin: 0 auto;
              padding: 20px;
            }       
            .health-grid {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
              gap: 15px;
              justify-items: center;
            }        
            .health-card {
              background: var(--card-bg);
              border-radius: 12px;
              padding: 20px;
              box-shadow: var(--card-shadow);
              width: 100%;
              max-width: 350px;
            }     
            .health-card-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 15px;
              border-bottom: 1px solid var(--border-color);
              padding-bottom: 10px;
              flex-direction: column;
              text-align: center;
              gap: 10px;
            }
            .health-hostname {
              font-size: 1.2rem;
              font-weight: bold;
              color: var(--primary);
            }     
            .health-status {
              display: grid;
              gap: 8px;
            }    
            .health-item {
              display: flex;
              justify-content: space-between;
              align-items: center;
            }   
            .health-label {
              color: var(--gray);
              font-size: 0.9rem;
            }        
            .health-value {
              font-weight: 600;
            } 
            .status-good { color: #2ecc71; }
            .status-warning { color: #f39c12; }
            .status-critical { color: #e74c3c; }
            
            @media (max-width: 768px) {
              .health-page {
                padding: 10px;
              }
              
              .health-grid {
                grid-template-columns: 1fr;
                gap: 10px;
              }
              
              .health-card {
                max-width: 100%;
              }
            }           
          '';
          code = ''
            <h1 style="text-align:center;">Machines Health</h1>
            <div id="healthContainer" class="health-grid"></div>

            <script>
              async function loadHealthData() {
                try {
                  const response = await fetch('/health/');
                  const text = await response.text();
                  
                  const parser = new DOMParser();
                  const htmlDoc = parser.parseFromString(text, 'text/html');
                  const links = Array.from(htmlDoc.querySelectorAll('a'));
                  const jsonFiles = links
                    .map(link => link.href)
                    .filter(href => href.endsWith('.json'))
                    .map(href => href.split('/').pop());
                  
                  console.log('Found health files:', jsonFiles);
                  
                  const container = document.getElementById('healthContainer');
                  container.innerHTML = "";
                  
                  for (const file of jsonFiles) {
                    try {
                      const healthResponse = await fetch('/health/' + file);
                      const healthData = await healthResponse.json();
                      createHealthCard(healthData, container);
                    } catch (error) {
                      console.error('Error loading health file:', file, error);
                    }
                  }
                  
                } catch (error) {
                  console.error('Error loading health directory:', error);
                  document.getElementById('healthContainer').innerHTML = 
                    '<div class="error">Unable to load health data</div>';
                }
              }
              
              function createHealthCard(data, container) {
                const card = document.createElement('div');
                card.className = 'health-card';
                
                const status = calculateOverallStatus(data);
                
                card.innerHTML = `
                  <div class="health-card-header">
                    <div class="health-hostname"><strong><h1>''${data.hostname}</h1></strong></div><br>
                    <div class="health-uptime">''${data.uptime}</div>
                  </div>
                  <div class="health-status">
                    <div class="health-item">
                      <span class="health-label"><strong>CPU:</strong></span>
                      <span class="health-value ''${getCPUStatusClass(data.cpu_usage)}">''${data.cpu_usage}%</span>
                    </div>
                    <div class="health-item">
                      <span class="health-label"><strong>Memory:</strong></span>
                      <span class="health-value ''${getMemoryStatusClass(data.memory_usage)}">''${data.memory_usage}%</span>
                    </div>
                    <div class="health-item">
                      <span class="health-label"><strong>CPU üå°Ô∏è:</strong></span>
                      <span class="health-value ''${getTempStatusClass(data.cpu_temperature)}">''${data.cpu_temperature}</span>
                    </div>
                    ''${createDiskUsageHTML(data.disk_usage)}
                    ''${createDiskTempHTML(data.disk_temperature)}
                  </div>
                `;
                
                container.appendChild(card);
              }
              
              function calculateOverallStatus(data) {
                if (data.cpu_usage > 90 || data.memory_usage > 90) return 'critical';
                if (data.cpu_usage > 80 || data.memory_usage > 80) return 'warning';
                return 'good';
              }
              
              function getCPUStatusClass(usage) {
                if (usage > 80) return 'status-critical';
                if (usage > 60) return 'status-warning';
                return 'status-good';
              }
              
              function getMemoryStatusClass(usage) {
                if (usage > 90) return 'status-critical';
                if (usage > 75) return 'status-warning';
                return 'status-good';
              }
              
              function getTempStatusClass(temp) {
                const tempValue = parseFloat(temp);
                if (tempValue > 70) return 'status-critical';
                if (tempValue > 60) return 'status-warning';
                return 'status-good';
              }
              
              function createDiskUsageHTML(diskUsage) {
                if (!diskUsage) return "";
                return Object.entries(diskUsage).map(([device, usage]) => `
                  <div class="health-item">
                    <span class="health-label"><strong>Disk</strong> (''${device}):</span>
                    <span class="health-value ''${getDiskStatusClass(usage)}">''${usage}</span>
                  </div>
                `).join("");
              }
              
              function createDiskTempHTML(diskTemp) {
                if (!diskTemp) return "";
                return Object.entries(diskTemp).map(([device, temp]) => `
                  <div class="health-item">
                    <span class="health-label"><strong>Disk üå°Ô∏è</strong>(''${device}):</span>
                    <span class="health-value ''${getTempStatusClass(temp)}">''${temp}</span>
                  </div>
                `).join("");
              }
              
              function getDiskStatusClass(usage) {
                const usageValue = parseFloat(usage);
                if (usageValue > 90) return 'status-critical';
                if (usageValue > 80) return 'status-warning';
                return 'status-good';
              }
              
              document.addEventListener('DOMContentLoaded', function() {
                if (document.getElementById('healthContainer')) {
                  loadHealthData();
                  setInterval(loadHealthData, 30000);
                }
              });
            </script>                
          '';
        };
    
      };
    };
  
    automations = {    
      mqtt_triggered = { // heallth };
    };
  };
</span><span class="clean-version hidden">
{
  self,
  lib,
  config,
  pkgs,
  cmdHelpers,
  ... 
} : let   

  sysHosts = lib.attrNames self.nixosConfigurations; 
  mqttHost = lib.findSingle (host:
      let cfg = self.nixosConfigurations.${host}.config;
      in cfg.services.mosquitto.enable or false
    ) null null sysHosts;    
  mqttHostip = if mqttHost != null
    then self.nixosConfigurations.${mqttHost}.config.this.host.ip or (
      let
        resolved = builtins.readFile (pkgs.runCommand "resolve-host" {} ''
          ${pkgs.dnsutils}/bin/host -t A ${mqttHost} > $out
        '');
      in
        lib.lists.head (lib.strings.splitString " " (lib.lists.elemAt (lib.strings.splitString "\n" resolved) 0))
    )
    else (throw "No Mosquitto host found in configuration");

  environment.systemPackages = [  ];  
  pyEnv = pkgs.python3.withPackages (ps: [ ps.psutil ]); 
  

  pyCheck = pkgs.writeScript "pyCheck.py" ''
    #!${pyEnv}/bin/python   
    import subprocess
    import psutil
    import sys
    import time
    import socket
    import os
    import json
    import re
    from datetime import timedelta
    import logging
    
    logging.basicConfig(level=logging.INFO)
    logger = logging.getLogger(__name__)
    
    def get_disk_temperature(disk: str):
        try:
            if disk.startswith('/dev/nvme'):
                cmd = ['sudo', 'nvme', 'smart-log', disk]
                result = subprocess.run(cmd,
                                      stdout=subprocess.PIPE,
                                      stderr=subprocess.PIPE,
                                      text=True,
                                      timeout=5)
                
                if result.returncode != 0:
                    return "failed"
                
                match = re.search(r'Temperature Sensor 1\s*:\s*(\d+)\s*¬∞C', result.stdout)
                return f"{match.group(1)}¬∞C" if match else "N/A"
            
            else:
                cmd = ['sudo', 'smartctl', '-a', disk]
                result = subprocess.run(cmd,
                                      stdout=subprocess.PIPE,
                                      stderr=subprocess.PIPE,
                                      text=True,
                                      timeout=5)
                
                if result.returncode != 0:
                    return "failed"
                
                for line in result.stdout.split('\n'):
                    if 'Temperature_Celsius' in line:
                        parts = line.split()
                        return f"{parts[9]}¬∞C" if len(parts) >= 10 else "N/A"
                return "N/A"
                
        except Exception as e:
            logger.error(f"Temperature error: {str(e)}")
            return "failed"
    
    def get_system_stats():
        stats = {
            "hostname": socket.gethostname(),
            "uptime": str(timedelta(seconds=time.time() - psutil.boot_time())),
            "cpu_usage": psutil.cpu_percent(interval=1),
            "cpu_temperature": "N/A",
            "memory_usage": psutil.virtual_memory().percent,
            "disk_usage": {},
            "disk_temperature": {}
        }
    
        try:
            temps = psutil.sensors_temperatures()
            if 'coretemp' in temps:
                stats["cpu_temperature"] = f"{temps['coretemp'][0].current}¬∞C"
        except Exception as e:
            logger.error(f"CPU temp error: {e}")
    
        disk_temp_cache = {}
        partitions = psutil.disk_partitions()
        
        lsblk_output = subprocess.check_output(
            ['lsblk', '-d', '-n', '-o', 'NAME'],
            text=True
        )
        physical_disks = [f"/dev/{line.strip()}" for line in lsblk_output.split('\n') if line]
    
        for disk in physical_disks:
            disk_temp_cache[disk] = get_disk_temperature(disk)
    
        shown_disks = set()
        for partition in partitions:
            try:
                stats["disk_usage"][partition.device] = f"{psutil.disk_usage(partition.mountpoint).percent}%"
                
                real_device = os.path.realpath(partition.device)
                parent = subprocess.check_output(
                    ['lsblk', '-no', 'pkname', real_device],
                    text=True
                ).strip()
                
                if parent:
                    parent_disk = f"/dev/{parent}"
                    if parent_disk not in shown_disks:
                        stats["disk_temperature"][parent_disk] = disk_temp_cache.get(parent_disk, "N/A")
                        shown_disks.add(parent_disk)
    
            except Exception as e:
                logger.error(f"Disk error: {e}")
                continue
    
        return stats
    
    if __name__ == "__main__":
        print(json.dumps(get_system_stats(), indent=4))
  '';   

  security.sudo.extraRules = [  
    {
      users = [ config.this.user.me.name ];
      commands = [
        {
          command = ${pyCheck};
          options = [ "NOPASSWD" ];
        }
      ];
    }  
  ];
  
  health = lib.mapAttrs (hostName: _: {
    enable = true;
    description = "Health Check: ${hostName}";
    topic = "zigbee2mqtt/health/${hostName}";
    actions = [
      {
         type = "shell";
         command = ''
           mkdir -p /var/lib/zigduck/health
           touch /var/lib/zigduck/health/${hostName}.json
           echo "$MQTT_PAYLOAD" > /var/lib/zigduck/health/${hostName}.json
        '';
       }
     ];
  }) self.nixosConfigurations;
    
in {   
  services.udev.packages = [ pkgs.nvme-cli pkgs.smartmontools ];
  environment.systemPackages = with pkgs; [ nvme-cli smartmontools util-linux ];
   
  yo.scripts.health = {
    description = "Health check and reporting across your machines. Returns JSON structured responses.";
    category = "üßπ Maintenance";  
    aliases = [ "hc" ];
    runEvery = "15"; # ü¶Ü15min
    code = ''
      ${cmdHelpers}            
      MQTT_BROKER="${mqttHostip}"
      MQTT_USER="${config.house.zigbee.mosquitto.username}"
      MQTT_PASSWORD=$(cat "${config.house.zigbee.mosquitto.passwordFile}")
      HC="$(sudo ${pyCheck})"
      mqtt_pub -t "zigbee2mqtt/health/${config.this.host.hostname}" -m "$HC"
    ''; 
  };

  house = {
    dashboard = {
      pages = {
        "4" = {
          icon = "fas fa-notes-medical";
          title = "health";
          files = { health = "/var/lib/zigduck/health"; };
          css = ''
            .health-page .container,
            .health-page .content,
            .health-page > div {
              width: 100% !important;
              max-width: 100% !important;
              margin: 0 !important;
              padding: 0 !important;
            }
            .page[data-page] {
              width: 100% !important;
              max-width: 100% !important;
            }
            .health-page {
              max-width: 1200px;
              margin: 0 auto;
              padding: 20px;
            }       
            .health-grid {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
              gap: 15px;
              justify-items: center;
            }        
            .health-card {
              background: var(--card-bg);
              border-radius: 12px;
              padding: 20px;
              box-shadow: var(--card-shadow);
              width: 100%;
              max-width: 350px;
            }     
            .health-card-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 15px;
              border-bottom: 1px solid var(--border-color);
              padding-bottom: 10px;
              flex-direction: column;
              text-align: center;
              gap: 10px;
            }
            .health-hostname {
              font-size: 1.2rem;
              font-weight: bold;
              color: var(--primary);
            }     
            .health-status {
              display: grid;
              gap: 8px;
            }    
            .health-item {
              display: flex;
              justify-content: space-between;
              align-items: center;
            }   
            .health-label {
              color: var(--gray);
              font-size: 0.9rem;
            }        
            .health-value {
              font-weight: 600;
            } 
            .status-good { color: #2ecc71; }
            .status-warning { color: #f39c12; }
            .status-critical { color: #e74c3c; }
            
            @media (max-width: 768px) {
              .health-page {
                padding: 10px;
              }
              
              .health-grid {
                grid-template-columns: 1fr;
                gap: 10px;
              }
              
              .health-card {
                max-width: 100%;
              }
            }           
          '';
          code = ''
            <h1 style="text-align:center;">Machines Health</h1>
            <div id="healthContainer" class="health-grid"></div>

            <script>
              async function loadHealthData() {
                try {
                  const response = await fetch('/health/');
                  const text = await response.text();
                  
                  const parser = new DOMParser();
                  const htmlDoc = parser.parseFromString(text, 'text/html');
                  const links = Array.from(htmlDoc.querySelectorAll('a'));
                  const jsonFiles = links
                    .map(link => link.href)
                    .filter(href => href.endsWith('.json'))
                    .map(href => href.split('/').pop());
                  
                  console.log('Found health files:', jsonFiles);
                  
                  const container = document.getElementById('healthContainer');
                  container.innerHTML = "";
                  
                  for (const file of jsonFiles) {
                    try {
                      const healthResponse = await fetch('/health/' + file);
                      const healthData = await healthResponse.json();
                      createHealthCard(healthData, container);
                    } catch (error) {
                      console.error('Error loading health file:', file, error);
                    }
                  }
                  
                } catch (error) {
                  console.error('Error loading health directory:', error);
                  document.getElementById('healthContainer').innerHTML = 
                    '<div class="error">Unable to load health data</div>';
                }
              }
              
              function createHealthCard(data, container) {
                const card = document.createElement('div');
                card.className = 'health-card';
                
                const status = calculateOverallStatus(data);
                
                card.innerHTML = `
                  <div class="health-card-header">
                    <div class="health-hostname"><strong><h1>''${data.hostname}</h1></strong></div><br>
                    <div class="health-uptime">''${data.uptime}</div>
                  </div>
                  <div class="health-status">
                    <div class="health-item">
                      <span class="health-label"><strong>CPU:</strong></span>
                      <span class="health-value ''${getCPUStatusClass(data.cpu_usage)}">''${data.cpu_usage}%</span>
                    </div>
                    <div class="health-item">
                      <span class="health-label"><strong>Memory:</strong></span>
                      <span class="health-value ''${getMemoryStatusClass(data.memory_usage)}">''${data.memory_usage}%</span>
                    </div>
                    <div class="health-item">
                      <span class="health-label"><strong>CPU üå°Ô∏è:</strong></span>
                      <span class="health-value ''${getTempStatusClass(data.cpu_temperature)}">''${data.cpu_temperature}</span>
                    </div>
                    ''${createDiskUsageHTML(data.disk_usage)}
                    ''${createDiskTempHTML(data.disk_temperature)}
                  </div>
                `;
                
                container.appendChild(card);
              }
              
              function calculateOverallStatus(data) {
                if (data.cpu_usage > 90 || data.memory_usage > 90) return 'critical';
                if (data.cpu_usage > 80 || data.memory_usage > 80) return 'warning';
                return 'good';
              }
              
              function getCPUStatusClass(usage) {
                if (usage > 80) return 'status-critical';
                if (usage > 60) return 'status-warning';
                return 'status-good';
              }
              
              function getMemoryStatusClass(usage) {
                if (usage > 90) return 'status-critical';
                if (usage > 75) return 'status-warning';
                return 'status-good';
              }
              
              function getTempStatusClass(temp) {
                const tempValue = parseFloat(temp);
                if (tempValue > 70) return 'status-critical';
                if (tempValue > 60) return 'status-warning';
                return 'status-good';
              }
              
              function createDiskUsageHTML(diskUsage) {
                if (!diskUsage) return "";
                return Object.entries(diskUsage).map(([device, usage]) => `
                  <div class="health-item">
                    <span class="health-label"><strong>Disk</strong> (''${device}):</span>
                    <span class="health-value ''${getDiskStatusClass(usage)}">''${usage}</span>
                  </div>
                `).join("");
              }
              
              function createDiskTempHTML(diskTemp) {
                if (!diskTemp) return "";
                return Object.entries(diskTemp).map(([device, temp]) => `
                  <div class="health-item">
                    <span class="health-label"><strong>Disk üå°Ô∏è</strong>(''${device}):</span>
                    <span class="health-value ''${getTempStatusClass(temp)}">''${temp}</span>
                  </div>
                `).join("");
              }
              
              function getDiskStatusClass(usage) {
                const usageValue = parseFloat(usage);
                if (usageValue > 90) return 'status-critical';
                if (usageValue > 80) return 'status-warning';
                return 'status-good';
              }
              
              document.addEventListener('DOMContentLoaded', function() {
                if (document.getElementById('healthContainer')) {
                  loadHealthData();
                  setInterval(loadHealthData, 30000);
                }
              });
            </script>                
          '';
        };
    
      };
    };
  
    automations = {    
      mqtt_triggered = { // heallth };
    };
  };
</span></pre>
            </div>
        </div>
    </details>        
    
            <br><br>
            This creates a page for the dashboard with system monitoring data that automatically updates without hardcoding any hostnames.<br><br>
            <br>
            <img src="../img/monitor1.png" height="400ppx" width="200px"><br>
            <img src="../img/monitor2.png" height="400ppx" width="200px"><br>
            <img src="../img/monitor3.png" height="400ppx" width="200px"><br>
        
        

            <h2 class="section-title">Source Code</h2>
            <br>

            <a href="https://github.com/QuackHack-McBlindy/dotfiles/blob/main/bin/home/duckDash.nix" class="source-link">
              View source code on GitHub
            </a><br>   



            <h2 class="section-title">Keep Reading</h2>
        
            <a href ="part1.html">Part 1. The module, the options and defining devices</a><br>
            <a href ="part2.html">Part 2. Configure your Mosquitto/Z2MQTT</a><br>
            <a href ="part3.html">Part 3. Nix Configured Automations</a> <br>           
            <a href ="part4.html">Part 4. Writing a Server Service - in Rust</a>  <br> 
            <a href ="part5.html">Part 5. Writing a Client - With Voice Commands</a> <br>
            <a href ="part6.html">Part 6. The Auto-Generated Dashboard</a><span class="current-marker">‚Æúü¶Ühere u are</span><br>    

            <br><br>
    

            <section id="comments">
              <h2>Comments on this blog post</h2>
              <script 
                src="https://utteranc.es/client.js"
                repo="QuackHack-McBlindy/blog"
                issue-term="pathname"
                theme="github-light"
                crossorigin="anonymous"
                async>
              </script>
            </section>
        </p>
    </div>



    </div>
    
    <footer>
        <p>All thoughts are my own and should not be considered advice of any kind. More likely the opposite.</p>
    </footer>

    <script>
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        const lightboxCaption = document.getElementById('lightbox-caption');
        const galleryImages = document.querySelectorAll('.gallery img');
        let currentIndex = 0;
        
        function openLightbox(index) {
            currentIndex = index;
            lightbox.style.display = 'block';
            lightboxImg.src = galleryImages[index].src;
            lightboxCaption.textContent = galleryImages[index].alt;
        }
        
        function closeLightbox() {
            lightbox.style.display = 'none';
        }
        
        function changeImage(direction) {
            currentIndex += direction;
            
            if (currentIndex >= galleryImages.length) {
                currentIndex = 0;
            } else if (currentIndex < 0) {
                currentIndex = galleryImages.length - 1;
            }
            
            lightboxImg.src = galleryImages[currentIndex].src;
            lightboxCaption.textContent = galleryImages[currentIndex].alt;
        }
        
        lightbox.addEventListener('click', function(event) {
            if (event.target === lightbox) {
                closeLightbox();
            }
        });
        
        document.addEventListener('keydown', function(event) {
            if (lightbox.style.display === 'block') {
                if (event.key === 'Escape') {
                    closeLightbox();
                } else if (event.key === 'ArrowLeft') {
                    changeImage(-1);
                } else if (event.key === 'ArrowRight') {
                    changeImage(1);
                }
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            const codeBlocks = document.querySelectorAll('details.code-block-container');
            
            codeBlocks.forEach(block => {
                const summary = block.querySelector('summary');
                const codeLang = summary.querySelector('.code-lang');
                const toggleIcon = summary.querySelector('.toggle-icon');
                
                const originalText = codeLang.innerHTML;
                const viewText = originalText.replace('Hide', 'View').replace('‚Æû', '‚Æü');
                const hideText = originalText.replace('View', 'Hide').replace('‚Æü', '‚Æû');
                
                if (block.open) {
                    codeLang.innerHTML = hideText;
                } else {
                    codeLang.innerHTML = viewText;
                }
                
                block.addEventListener('toggle', function() {
                    if (this.open) {
                        codeLang.innerHTML = hideText;
                    } else {
                        codeLang.innerHTML = viewText;
                    }
                });
            });
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            const duckToggle = document.getElementById('duckToggle');
            let ducksHidden = false;
            
            function toggleCodeDucks() {
                ducksHidden = !ducksHidden;
                
                const duckVersions = document.querySelectorAll('.duck-version');
                const cleanVersions = document.querySelectorAll('.clean-version');
                
                duckVersions.forEach(version => {
                    version.classList.toggle('hidden', ducksHidden);
                });
                
                cleanVersions.forEach(version => {
                    version.classList.toggle('hidden', !ducksHidden);
                });
                
                duckToggle.innerHTML = ducksHidden ? 
                    '<span class="duck-icon"></span> Show ü¶Ü commentary' : 
                    '<span class="duck-icon"></span> Hide ü¶Ü commentary';
                    
                const duckIcon = duckToggle.querySelector('.duck-icon');
                duckIcon.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    duckIcon.style.transform = 'scale(1)';
                }, 300);
            }
            
            duckToggle.addEventListener('click', toggleCodeDucks);
            
            document.querySelectorAll('.clean-version').forEach(version => {
                version.classList.add('hidden');
            });
        });
    </script>
</body>
</html>
