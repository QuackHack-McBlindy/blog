<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Blog about declarative home automation, smart home systems, and avoiding vendor lock-in with Nix-based solutions">
    <meta property="og:title" content="Declarative Home Automation with Nix">
    <meta property="og:description" content="Learn how to define your smart home devices and avoid vendor lock-in">
    <meta property="og:type" content="article">
    <meta name="twitter:card" content="summary_large_image">
    <title>ü¶Üüßë‚Äçü¶Ø'blog</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>

    <div class="navbar">
        <div class="navbar-content">
            <a href="https://github.com/QuackHack-McBlindy" title="GitHub">
                <img src="../img/github_teal.png" alt="GitHub" class="github-icon" style="height: 32px;" onmouseover="this.src='../img/github_magenta.png';" onmouseout="this.src='../img/github_teal.png';"> </img>
            </a>
            
            <div class="navbar-title">
                <span>ü¶Ü</span>üßë‚Äçü¶Ø <a href="https://quackhack-mcblindy.github.io/blog/">QuackHack-McBlindy blog</a>
            </div>
            <img src="../img/logo.png" height="48" width="48" >
            <button id="duckToggle" class="toggle-btn" aria-label="Toggle duck commentary">

                <span class="duck-icon">ü¶Ü</span>
                Hide duck commentary
            </button>
        </div>
    </div>
    

    <div class="toc-container">
        <details class="toc-details">
            <summary class="toc-header">
                <span class="toc-duck">ü¶Ü</span>
                <h3>Navigation</h3>
                <span class="toc-man">üßë‚Äçü¶Ø</span>
                <span class="toc-toggle">‚Æü</span>
            </summary>
            <nav class="toc-nav">
                <a href="../yo/index.html" class="toc-item">
                    <span class="toc-icon">ü´Ä</span>
                    Yo - Define & Unify
                </a>
                <a href="../do/index.html" class="toc-item">
                    <span class="toc-icon">üß†</span>
                    Do - Listen, Process, Act & Learn
                </a>
                <a href="index.html" class="toc-item current">
                    <span class="toc-icon">üè†</span>
                    House - Declarative Home Automation
                    <span class="current-marker">‚Æúü¶Ü</span>
                </a>
                <a href="../docs/index.html" class="toc-item">
                    <span class="toc-icon">üìö</span>
                    Documentation - Automating the README
                </a>
                <a href="../misc/index.html" class="toc-item">
                    <span class="toc-icon">üß©</span>
                    Miscellaneous 
                </a>
            </nav>
            <div class="toc-footer">
                <span class="toc-quack">ü¶Ü says ‚Æû qwack qwack, plx pick!</span>
            </div>
        </details>
    </div>
    
  
    <div class="content">
        <header class="category-title">
            <h1>Defining Your Home</h1>
            <p class="subtitle"> Part 5 - Writing a Client With Voice Commands</p>
        </header>

        
        <div class="duck-comment">
            <p>says ‚Æû I use 20x magnification when I code and debug. I use emoji to simplify logs for myself. If you can't handle my code style you can disable most of it on this website by toggling the button in the navbar. Shall duck continue? </p>
        </div>



        <h2 class="section-title">Hello Voice Control</h2>
        <br>
        <p>
          If you have followed along these past pages you can already control your devices using commands: <br>
          <br>
          <strong>zig</strong> - For controlling devices.<br>
          <strong>scene</strong> - For setting scenes.<br>
          <br>
          They are both basic commands and might not be optimal, let's write a proper one.<br>
          
          This part is going to be <strong>voice commands!</strong> focused. <br> 
          Of course you can do this in multiple other ways if you don't want to go this route, but I am going to assume that you are using yo for this time.<br> 
          <br>
          
          This voice controlled Zigbee light controller will be able to handle the device in every single possible way.<br><br>
          <br>        
          I will split it into <strong>three</strong> phases, I think the parameters section and the entity lists might get intense, so hold on.<br>
          
          <div class="duck-comment">
              <p>
                  says ‚Æû let'z call da script DuckBee, DB - ok let'z qwaaaack. 
              </p>
          </div>    
          
          
        </p>  


            <h2 class="section-title">Phase 1: Yo! Let's Definine DB!</h2>
            <p>We start by giving it a name, description, alias etc.<br>
            We will also define the parameters for the Zigbee Voice Controller.<br>
            <br>

            </p>


        <details class="code-block-container" style="margin-bottom: 1em;">
          <summary class="code-header">
              <div class="code-lang">‚Æû View yo.scripts.DuckBee</div>
          </summary>
              <div class="code-block">
                <pre><span class="duck-version">
  yo.scripts.DuckBee = {
    description = "DuckBee Control lights and other home automatioon devices";
    category = "üõñ Home Automation";
    aliases = [ "DB" ];
    autoStart = false;
    logLevel = "DEBUG";
    parameters = [   
      { name = "device"; description = "Device to control"; optional = true; }
      { name = "state"; type = "string"; description = "State of the device or group"; } 
      { name = "brightness"; description = "Brightness value of the device or group"; optional = true; type = "int"; }    
      { name = "color"; description = "Color to set on the device"; optional = true; }    
      { name = "temperature"; description = "Light color temperature to set on the device"; optional = true; }          
      { name = "scene"; description = "Activate a predefined scene"; optional = true; }     
      { name = "room"; description = "Room to target"; optional = true; }        
      { name = "user"; description = "Mosquitto username to use"; default = "mqtt"; }    
      { name = "passwordfile"; description = "File path containing password for Mosquitto user"; default = config.sops.secrets.mosquitto.path; }
      { name = "flake"; description = "Path containing flake.nix"; default = config.this.user.me.dotfilesDir; }
      { name = "pair"; type = "bool"; description = "Activate zigbee2mqtt pairring and start searching for new devices"; default = false; }
      { name = "cheapMode"; type = "bool"; description = "Energy saving mode. Turns off the lights again after X seconds."; default = false; }
    ];
</span><span class="clean-version hidden">
  yo.scripts.DuckBee = {
    description = "DuckBee Control lights and other home automatioon devices";
    aliases = [ "DB" ];
    category = "üõñ Home Automation";
    autoStart = false;
    logLevel = "DEBUG";
    parameters = [   
      { name = "device"; description = "Device to control"; optional = true; }
      { name = "state"; type = "string"; description = "State of the device or group"; } 
      { name = "brightness"; description = "Brightness value of the device or group"; optional = true; type = "int"; }    
      { name = "color"; description = "Color to set on the device"; optional = true; }    
      { name = "temperature"; description = "Light color temperature to set on the device"; optional = true; }          
      { name = "scene"; description = "Activate a predefined scene"; optional = true; }     
      { name = "room"; description = "Room to target"; optional = true; }        
      { name = "user"; description = "Mosquitto username to use"; default = "mqtt"; }    
      { name = "passwordfile"; description = "File path containing password for Mosquitto user"; default = config.sops.secrets.mosquitto.path; }
      { name = "flake"; description = "Path containing flake.nix"; default = config.this.user.me.dotfilesDir; }
      { name = "pair"; type = "bool"; description = "Activate zigbee2mqtt pairring and start searching for new devices"; default = false; }
      { name = "cheapMode"; type = "bool"; description = "Energy saving mode. Turns off the lights again after X seconds."; default = false; }
    ];
</span></pre>
            </div>
        </div>
    </details>        









            <h2 class="section-title">Phase 2: Yo Bash! Take it from here!</h2>
            <p>Here you can do basically anything you want.<br>
            I hpwever, are gpomg to show how to control your devices!<br>
            <br>

            </p>


        <details class="code-block-container" style="margin-bottom: 1em;">
          <summary class="code-header">
              <div class="code-lang">‚Æû View yo.scripts.DuckBee.code</div>
          </summary>
              <div class="code-block">
                <pre><span class="duck-version">
      ${cmdHelpers}
 #     set -euo pipefail
      # ü¶Ü says ‚Æû create case insensitive map of device friendly_name
      declare -A device_map=( ${lib.concatStringsSep "\n" (lib.mapAttrsToList (k: v: "['${lib.toLower k}']='${v}'") normalizedDeviceMap)} )
      available_devices=( ${toString deviceList} )      
      DOTFILES="$flake"
      STATE_DIR="${zigduckDir}"
      DEVICE="$device"
      STATE="$state"
      SCENE="$scene"
      BRIGHTNESS="$brightness"
      COLOR="$color"
      TEMP="$temperature"
      MQTT_BROKER="${mqttHostIp}"
      PWFILE="$passwordfile"
      MQTT_USER="$user"
      MQTT_PASSWORD=$(cat "$PWFILE")
      ROOM="$device"
      touch "$STATE_DIR/voice-debug.log"        
      if [[ "$cheapMode" == "true" ]]; then
        reset_room_timer "$ROOM"
        dt_info "Restarting room timer for $ROOM" 
        exit 0
      fi
      if [[ -n "$SCENE" && -z "$DEVICE" ]]; then
        scene "$SCENE"
        exit 0
      fi
      
      if [[ "$pair" == "true" ]]; then
        echo "ü¶Ü Activating Zigbee2MQTT pairing mode for 120 seconds..."
        mqtt_pub -t "zigbee2mqtt/bridge/request/permit_join" -m '{"value": true, "time": 120}'    
        dt_info "üì° Searching for new Zigbee devices... Put your device in pairing mode now!"
        dt_info "‚è∞ Pairing mode! 120 sec... (Ctrl+C to stop early)"
        cleanup() {
          dt_debug "Disabling pairing mode..."
          mqtt_pub -t "zigbee2mqtt/bridge/request/permit_join" -m '{"value": false}'
          exit 0
        }
        trap cleanup INT TERM EXIT
        ${pkgs.mosquitto}/bin/mosquitto_sub -h "$MQTT_BROKER" -u "$MQTT_USER" -P "$MQTT_PASSWORD" \
        -t "zigbee2mqtt/bridge/event" -t "zigbee2mqtt/bridge/log" | while IFS= read -r line; do
        
        dt_debug "Received: $line"
                   
        if echo "$line" | jq -e '.type == "device_joined"' > /dev/null 2>&1; then
          device_data=$(echo "$line" | jq -r '.data')
          friendly_name=$(echo "$device_data" | jq -r '.friendly_name')
          ieee_address=$(echo "$device_data" | jq -r '.ieee_address')
          echo "‚úÖ New device joined: $friendly_name ($ieee_address)"
        fi
                
        if echo "$line" | jq -e '.type == "device_interview"' > /dev/null; then
          interview_data=$(echo "$line" | jq -r '.data')
          status=$(echo "$interview_data" | jq -r '.status')
          ieee_address=$(echo "$interview_data" | jq -r '.ieee_address')
                    
          if [[ "$status" == "successful" ]]; then
            model=$(echo "$interview_data" | jq -r '.definition.model // "unknown"')
            vendor=$(echo "$interview_data" | jq -r '.definition.vendor // "unknown"')
            description=$(echo "$interview_data" | jq -r '.definition.description // "unknown"')      
            dt_info "üéâ Device interview successful!"
            dt_info "Model: $model"
            dt_info "Vendor: $vendor" 
            dt_info "Description: $description"
            dt_info "IEEE: $ieee_address"
                        
            cat << EOF
ü¶Ü says ‚Æû To add this device to your Nix configuration, add to `house.zigbee.devices`:

''${ieee_address} = {
  friendly_name = "$friendly_name";
  room = "unknown"; # ‚Æú ü¶Ü says ‚Æû Set the room name
  type = "unknown"; # ‚Æú ü¶Ü says ‚Æû Set device type (light, dimmer, sensor, motion, outlet, remote, pusher, blind)
  endpoint = 11;     # ‚Æú ü¶Ü says ‚Æû Set endpoint if needed
  icon = "mdi:toggle-switch"; # ‚Æú ü¶Ü says ‚Æû Set icon for frontend
  batteryType = "CR2450"; }; # ‚Æú ü¶Ü says ‚Æû Optional option if device has a battery. (AAA, CR1, CR2032, CR2450) 
};

EOF
            elif [[ "$status" == "failed" ]]; then
              dt_warning "‚ùå Device interview failed for $ieee_address"
            fi
          fi
        
          if echo "$line" | jq -e '.message != null' > /dev/null 2>&1; then
            message=$(echo "$line" | jq -r '.message')
            level=$(echo "$line" | jq -r '.level // "info"')
            
            if [[ "$level" == "info" ]]; then
              dt_info "Bridge: $message"
            elif [[ "$level" == "warning" ]]; then
              dt_warning "Bridge: $message"
            elif [[ "$level" == "error" ]]; then
              dt_error "Bridge: $message"
            else
              dt_debug "Bridge: $message"
            fi
          fi
        done
    
        cleanup
      fi
      if [[ "$DEVICE" == "ALL_LIGHTS" ]]; then
        if [[ "$STATE" == "ON" ]]; then
          scene max
          if_voice_say "Jag maxade alla lampor brorsan."
        elif [[ "$STATE" == "OFF" ]]; then
          scene dark
          if_voice_say "Nu blev det m√∂rkt!"
        else
          echo "$(date) - ‚ùå Unknown state for all_lights: $STATE" >> "$STATE_DIR/voice-debug.log"
          say_duck "‚ùå Unknown state for all_lights: $STATE"
          exit 1
        fi
        exit 0
      fi
      control_device() {
        local dev="$1"
        local state="$2"
        local brightness="$3"
        local color_input="$4"      
        local hex_code=""
        if [[ "$dev" == "Smoke Alarm Kitchen" ]]; then
          dt_info "$dev is a sensor, exiting"
          return 0
        fi
        if [[ -n "$color_input" ]]; then
          if [[ "$color_input" =~ ^#[0-9a-fA-F]{6}$ ]]; then
            hex_code="$color_input"
          else
            hex_code=$(color2hex "$color_input") || {
              echo "$(date) - ‚ùå Unknown color: $color_input" >> "$STATE_DIR/voice-debug.log"
              say_duck "fuck ‚ùå Invalid color: $color_input"
              exit 1
            }
          fi
        fi
        
        if [[ -n "$SCENE" ]]; then
          scene $SCENE
          say_duck "Activated scene $SCENE"
        fi   
        
        if [[ "$state" == "off" ]]; then
          mqtt_pub -t "zigbee2mqtt/$dev/set" -m '{"state":"OFF"}'
          say_duck "Turned off $dev"
          if_voice_say "St√§ngde av $dev"
        else
          # ü¶Ü says ‚Æû Validate brightness value
          if [[ -n "$brightness" ]]; then
            if ! [[ "$brightness" =~ ^[0-9]+$ ]] || [ "$brightness" -lt 1 ] || [ "$brightness" -gt 100 ]; then
              echo "Unknown brightness: $brightness" >> "$STATE_DIR/voice-debug.log"
              say_duck "Ogiltig ljusstyrka: $brightness%. Ange 1-100."
              exit 1
            fi
            brightness=$((brightness * 254 / 100))
          fi
          local payload='{"state":"ON"'
          [[ -n "$brightness" ]] && payload+=", \"brightness\":$brightness"
          [[ -n "$hex_code" ]] && payload+=", \"color\":{\"hex\":\"$hex_code\"}"
          payload+="}"
          mqtt_pub -t "zigbee2mqtt/$dev/set" -m "$payload"
          say_duck "Set $dev: $payload"
          if_voice_say "Klart kompis"
        fi
      }
      
      if [[ -n "$DEVICE" ]]; then
        input_lower=$(echo "$DEVICE" | tr '[:upper:]' '[:lower:]')
        exact_name="''${device_map["''$input_lower"]:-}"   
        if [[ -n "$exact_name" ]]; then
          control_device "$exact_name" "$STATE" "$BRIGHTNESS" "$COLOR"
          exit 0

        else
          for dev in "''${!device_map[@]}"; do
            if [[ "$dev" == *"$input_lower"* ]]; then
              exact_name="''${device_map[$dev]}"
              break
            fi
          done
          
          if [[ -n "$exact_name" ]]; then
            control_device "$exact_name" "$STATE" "$BRIGHTNESS" "$COLOR"
            exit 0
          fi
          
          group_topics=($(jq -r '.groups | keys[]' "$STATE_DIR/zigbee_devices.json"))
          for group in "''${group_topics[@]}"; do
            if [[ "$(echo "$group" | tr '[:upper:]' '[:lower:]')" == *"$input_lower"* ]]; then
              control_group "$group" "$STATE" "$BRIGHTNESS" "$COLOR"
              exit 0
            fi
          done
             
          AREA="$DEVICE"
          say_duck "‚ö†Ô∏è Device '$DEVICE' not found, trying as area '$AREA'"
          echo "$(date) - ‚ö†Ô∏è Device $DEVICE not found as area" >> "$STATE_DIR/voice-debug.log"
        fi
      fi
            
      control_room() {
        local room="$1"
        if [[ -z "$room" ]]; then
          echo "Usage: control_room <room-name>"
          return 1
        fi
      
        readarray -t devices < <(nix eval $DOTFILES#nixosConfigurations.desktop.config.house --json \
          | jq -r --arg room "$room" '
              .zigbee.devices
              | to_entries
              | map(select(.value.room == $room and .value.type == "light"))
              | map(.value.friendly_name)
              | .[]')
      
        for light_id in "''${devices[@]}"; do
          local hex_code=""
               
          if [[ -n "$COLOR" ]]; then
            hex_code=$(color2hex "$COLOR") || {
              echo "$(date) - ‚ùå Unknown color: $COLOR" >> "$STATE_DIR/voice-debug.log"
              say_duck "‚ùå Invalid color: $COLOR"
              continue
            }
          fi
      
          local payload='{"state":"ON"'
          [[ -n "$BRIGHTNESS" ]] && payload+=", \"brightness\":$BRIGHTNESS"
          [[ -n "$hex_code" ]] && payload+=", \"color\":{\"hex\":\"$hex_code\"}"
          payload+="}"
      
          if [[ "$light_id" == *"Smoke"* || "$light_id" == *"Sensor"* || "$light_id" == *"Alarm"* ]]; then
            echo "Skipping invalid light device: $light_id" >> "$STATE_DIR/voice-debug.log"
            continue
          fi

      
          mqtt_pub -t "zigbee2mqtt/$light_id/set" -m "$payload"
          say_duck "$light_id $payload"
        done
      }
      
      if [[ -n "$AREA" ]]; then
        normalized_area=$(echo "$AREA" | tr '[:upper:]' '[:lower:]' | tr -d '[:space:]')
        control_room $AREA
      fi        
    ''; 
</span><span class="clean-version hidden">
    code = ''  
      declare -A device_map=( ${lib.concatStringsSep "\n" (lib.mapAttrsToList (k: v: "['${lib.toLower k}']='${v}'") normalizedDeviceMap)} )
      available_devices=( ${toString deviceList} )      
      DOTFILES="$flake"
      STATE_DIR="${zigduckDir}"
      DEVICE="$device"
      STATE="$state"
      SCENE="$scene"
      BRIGHTNESS="$brightness"
      COLOR="$color"
      TEMP="$temperature"
      MQTT_BROKER="${mqttHostIp}"
      PWFILE="$passwordfile"
      MQTT_USER="$user"
      MQTT_PASSWORD=$(cat "$PWFILE")
      ROOM="$device"
      touch "$STATE_DIR/voice-debug.log"        
      if [[ "$cheapMode" == "true" ]]; then
        reset_room_timer "$ROOM"
        dt_info "Restarting room timer for $ROOM" 
        exit 0
      fi
      if [[ -n "$SCENE" && -z "$DEVICE" ]]; then
        scene "$SCENE"
        exit 0
      fi
      
      if [[ "$pair" == "true" ]]; then
        echo "ü¶Ü Activating Zigbee2MQTT pairing mode for 120 seconds..."
        mqtt_pub -t "zigbee2mqtt/bridge/request/permit_join" -m '{"value": true, "time": 120}'    
        dt_info "üì° Searching for new Zigbee devices... Put your device in pairing mode now!"
        dt_info "‚è∞ Pairing mode! 120 sec... (Ctrl+C to stop early)"
        cleanup() {
          dt_debug "Disabling pairing mode..."
          mqtt_pub -t "zigbee2mqtt/bridge/request/permit_join" -m '{"value": false}'
          exit 0
        }
        trap cleanup INT TERM EXIT
        ${pkgs.mosquitto}/bin/mosquitto_sub -h "$MQTT_BROKER" -u "$MQTT_USER" -P "$MQTT_PASSWORD" \
        -t "zigbee2mqtt/bridge/event" -t "zigbee2mqtt/bridge/log" | while IFS= read -r line; do
        
        dt_debug "Received: $line"
                   
        if echo "$line" | jq -e '.type == "device_joined"' > /dev/null 2>&1; then
          device_data=$(echo "$line" | jq -r '.data')
          friendly_name=$(echo "$device_data" | jq -r '.friendly_name')
          ieee_address=$(echo "$device_data" | jq -r '.ieee_address')
          echo "‚úÖ New device joined: $friendly_name ($ieee_address)"
        fi
                
        if echo "$line" | jq -e '.type == "device_interview"' > /dev/null; then
          interview_data=$(echo "$line" | jq -r '.data')
          status=$(echo "$interview_data" | jq -r '.status')
          ieee_address=$(echo "$interview_data" | jq -r '.ieee_address')
                    
          if [[ "$status" == "successful" ]]; then
            model=$(echo "$interview_data" | jq -r '.definition.model // "unknown"')
            vendor=$(echo "$interview_data" | jq -r '.definition.vendor // "unknown"')
            description=$(echo "$interview_data" | jq -r '.definition.description // "unknown"')      
            dt_info "üéâ Device interview successful!"
            dt_info "Model: $model"
            dt_info "Vendor: $vendor" 
            dt_info "Description: $description"
            dt_info "IEEE: $ieee_address"
                        
            cat << EOF
ü¶Ü says ‚Æû To add this device to your Nix configuration, add to `house.zigbee.devices`:

''${ieee_address} = {
  friendly_name = "$friendly_name";
  room = "unknown"; # ‚Æú ü¶Ü says ‚Æû Set the room name
  type = "unknown"; # ‚Æú ü¶Ü says ‚Æû Set device type (light, dimmer, sensor, motion, outlet, remote, pusher, blind)
  endpoint = 11;     # ‚Æú ü¶Ü says ‚Æû Set endpoint if needed
  icon = "mdi:toggle-switch"; # ‚Æú ü¶Ü says ‚Æû Set icon for frontend
  batteryType = "CR2450"; }; # ‚Æú ü¶Ü says ‚Æû Optional option if device has a battery. (AAA, CR1, CR2032, CR2450) 
};

EOF
            elif [[ "$status" == "failed" ]]; then
              dt_warning "‚ùå Device interview failed for $ieee_address"
            fi
          fi
        
          if echo "$line" | jq -e '.message != null' > /dev/null 2>&1; then
            message=$(echo "$line" | jq -r '.message')
            level=$(echo "$line" | jq -r '.level // "info"')
            
            if [[ "$level" == "info" ]]; then
              dt_info "Bridge: $message"
            elif [[ "$level" == "warning" ]]; then
              dt_warning "Bridge: $message"
            elif [[ "$level" == "error" ]]; then
              dt_error "Bridge: $message"
            else
              dt_debug "Bridge: $message"
            fi
          fi
        done
    
        cleanup
      fi
      if [[ "$DEVICE" == "ALL_LIGHTS" ]]; then
        if [[ "$STATE" == "ON" ]]; then
          scene max
          if_voice_say "Jag maxade alla lampor brorsan."
        elif [[ "$STATE" == "OFF" ]]; then
          scene dark
          if_voice_say "Nu blev det m√∂rkt!"
        else
          echo "$(date) - ‚ùå Unknown state for all_lights: $STATE" >> "$STATE_DIR/voice-debug.log"
          say_duck "‚ùå Unknown state for all_lights: $STATE"
          exit 1
        fi
        exit 0
      fi
      control_device() {
        local dev="$1"
        local state="$2"
        local brightness="$3"
        local color_input="$4"      
        local hex_code=""
        if [[ "$dev" == "Smoke Alarm Kitchen" ]]; then
          dt_info "$dev is a sensor, exiting"
          return 0
        fi
        if [[ -n "$color_input" ]]; then
          if [[ "$color_input" =~ ^#[0-9a-fA-F]{6}$ ]]; then
            hex_code="$color_input"
          else
            hex_code=$(color2hex "$color_input") || {
              echo "$(date) - ‚ùå Unknown color: $color_input" >> "$STATE_DIR/voice-debug.log"
              say_duck "fuck ‚ùå Invalid color: $color_input"
              exit 1
            }
          fi
        fi
        
        if [[ -n "$SCENE" ]]; then
          scene $SCENE
          say_duck "Activated scene $SCENE"
        fi   
        
        if [[ "$state" == "off" ]]; then
          mqtt_pub -t "zigbee2mqtt/$dev/set" -m '{"state":"OFF"}'
          say_duck "Turned off $dev"
          if_voice_say "St√§ngde av $dev"
        else
          if [[ -n "$brightness" ]]; then
            if ! [[ "$brightness" =~ ^[0-9]+$ ]] || [ "$brightness" -lt 1 ] || [ "$brightness" -gt 100 ]; then
              echo "Unknown brightness: $brightness" >> "$STATE_DIR/voice-debug.log"
              say_duck "Ogiltig ljusstyrka: $brightness%. Ange 1-100."
              exit 1
            fi
            brightness=$((brightness * 254 / 100))
          fi
          local payload='{"state":"ON"'
          [[ -n "$brightness" ]] && payload+=", \"brightness\":$brightness"
          [[ -n "$hex_code" ]] && payload+=", \"color\":{\"hex\":\"$hex_code\"}"
          payload+="}"
          mqtt_pub -t "zigbee2mqtt/$dev/set" -m "$payload"
          say_duck "Set $dev: $payload"
          if_voice_say "Klart kompis"
        fi
      }
      
      if [[ -n "$DEVICE" ]]; then
        input_lower=$(echo "$DEVICE" | tr '[:upper:]' '[:lower:]')
        exact_name="''${device_map["''$input_lower"]:-}"   
        if [[ -n "$exact_name" ]]; then
          control_device "$exact_name" "$STATE" "$BRIGHTNESS" "$COLOR"
          exit 0

        else
          for dev in "''${!device_map[@]}"; do
            if [[ "$dev" == *"$input_lower"* ]]; then
              exact_name="''${device_map[$dev]}"
              break
            fi
          done
          
          if [[ -n "$exact_name" ]]; then
            control_device "$exact_name" "$STATE" "$BRIGHTNESS" "$COLOR"
            exit 0
          fi
          
          group_topics=($(jq -r '.groups | keys[]' "$STATE_DIR/zigbee_devices.json"))
          for group in "''${group_topics[@]}"; do
            if [[ "$(echo "$group" | tr '[:upper:]' '[:lower:]')" == *"$input_lower"* ]]; then
              control_group "$group" "$STATE" "$BRIGHTNESS" "$COLOR"
              exit 0
            fi
          done
             
          AREA="$DEVICE"
          say_duck "‚ö†Ô∏è Device '$DEVICE' not found, trying as area '$AREA'"
          echo "$(date) - ‚ö†Ô∏è Device $DEVICE not found as area" >> "$STATE_DIR/voice-debug.log"
        fi
      fi
            
      control_room() {
        local room="$1"
        if [[ -z "$room" ]]; then
          echo "Usage: control_room <room-name>"
          return 1
        fi
      
        readarray -t devices < <(nix eval $DOTFILES#nixosConfigurations.desktop.config.house --json \
          | jq -r --arg room "$room" '
              .zigbee.devices
              | to_entries
              | map(select(.value.room == $room and .value.type == "light"))
              | map(.value.friendly_name)
              | .[]')
      
        for light_id in "''${devices[@]}"; do
          local hex_code=""
               
          if [[ -n "$COLOR" ]]; then
            hex_code=$(color2hex "$COLOR") || {
              echo "$(date) - ‚ùå Unknown color: $COLOR" >> "$STATE_DIR/voice-debug.log"
              say_duck "‚ùå Invalid color: $COLOR"
              continue
            }
          fi
      
          local payload='{"state":"ON"'
          [[ -n "$BRIGHTNESS" ]] && payload+=", \"brightness\":$BRIGHTNESS"
          [[ -n "$hex_code" ]] && payload+=", \"color\":{\"hex\":\"$hex_code\"}"
          payload+="}"
      
          if [[ "$light_id" == *"Smoke"* || "$light_id" == *"Sensor"* || "$light_id" == *"Alarm"* ]]; then
            echo "Skipping invalid light device: $light_id" >> "$STATE_DIR/voice-debug.log"
            continue
          fi

      
          mqtt_pub -t "zigbee2mqtt/$light_id/set" -m "$payload"
          say_duck "$light_id $payload"
        done
      }
      
      if [[ -n "$AREA" ]]; then
        normalized_area=$(echo "$AREA" | tr '[:upper:]' '[:lower:]' | tr -d '[:space:]')
        control_room $AREA
      fi        
    ''; 
</span></pre>
            </div>
        </div>
    </details>        

        
        








            <h2 class="section-title">Phase 3: Yo! Define DB Sentences!</h2>
            <p>We must first define sentences.<br>
            Then we map the entity lists for the parameter resolution.<br>
            <br><br>
            
            <div class="callout">
                <p>
                    <strong>REMEMBER:</strong><br><br>
                    <strong>(alternative|words)</strong>  - These words are alternative words, one must be said.<br>
                    <strong>[optional|words]</strong>     - Any of these words can be said. But not rquired.<br>
                    <strong>{parameters}</strong>- These are parameters. If the parameter is wildcard, it can be anything.<br>
                </p>
            </div><br>  


            </p>


        <details class="code-block-container" style="margin-bottom: 1em;">
          <summary class="code-header">
              <div class="code-lang">‚Æû View yo.scripts.DuckBee.voice</div>
          </summary>
              <div class="code-block">
                <pre><span class="duck-version">
  voice = {
      priority = 1;
      sentences = [
        "(turn on|switch on|activate|start|power on) {device}"
        "(turn off|switch off|deactivate|stop|power off) {device}"
        "(turn|switch) {device} {state}"
        "(turn|switch) {state} {device}"
        "{device} {state} and brightness {brightness} percent"
        "{device} {state} with {color} color and {brightness} percent brightness"
        "{device} {state} in {room} and [change] color [to] {color} [and] brightness [to] {brightness} percent"

        # ü¶Ü says ‚Æû simple room-light control
        "{state} (all|every) light[s] in {room}"
        "{state} {room} light[s]"
        "{state} (all|every) light[s]"
        "{state} (all|every) {device} light[s]"
        "control (all|every) light[s] in {room}"
        "manage {room} lighting"

        # ü¶Ü says ‚Æû color control
        "(change|set|adjust) {device} color to {color}"
        "(change|set|adjust) color of {device} to {color}"
        "make {device} {color}"
        "set {device} to {color} color"
        "apply {color} color to {device}"

        # ü¶Ü says ‚Æû brightness control
        "(adjust|set|change) {device} brightness to {brightness} percent"
        "(adjust|set|change) brightness of {device} to {brightness} percent"
        "make {device} {brightness} percent brightness"
        "set {device} to {brightness} percent brightness"
        "dim {device} to {brightness} percent"
        "brighten {device} to {brightness} percent"

        # ü¶Ü says ‚Æû scene/ambiance control
        "create {scene} (scene|mode|atmosphere) in {room}"
        "set {room} to {scene} (scene|mode|atmosphere)"
        "activate {scene} mode"

        # ü¶Ü says ‚Æû multi taskerz (complex, strict patterns LAST)
        "set {room} lights to {state} with {color} at {brightness} percent and activate {scene}"
        "{device} {state} in {room} with {color} color at {brightness} percent and temperature {temperature} using scene {scene}"
        "configure {device} in {room} with {color} color, {brightness} percent brightness, and {temperature} temperature"
        "create {scene} atmosphere in {room} using {color} lighting at {brightness} percent [in cheap mode]"
        "adjust all lights in {room} to {color} with {brightness} percent brightness and set {temperature} temperature"

        # ü¶Ü says ‚Æû pairing mode
        "{pair} [new] [zigbee] (device|devices|sensor|sensors)"
        "start {pair} [new] device[s]"
        "enable {pair} mode for new devices"
        "begin device {pair}"
      ];        
      lists = {
        state.values = [
          { "in" = "[t√§nd|t√§nda|t√§nk|start|starta|p√•|t√∂nd|t√∂md]"; out = "ON"; }             
          { "in" = "[sl√§ck|sl√§cka|slick|av|st√§ng|st√§ng av]"; out = "OFF"; } 
        ];
        brightness.values = builtins.genList (i: {
          "in" = toString (i + 1);
          out = toString (i + 1);
        }) 100 ++ [
          { "in" = "[full|maximum|max|hundred]"; out = "100"; }
          { "in" = "[half|fifty|medium]"; out = "50"; }
          { "in" = "[quarter|twenty five|low]"; out = "25"; }
          { "in" = "[ten percent|minimal|dim]"; out = "10"; }
          { "in" = "[five percent|minimum|min]"; out = "5"; }
          { "in" = "[zero|off|dark]"; out = "0"; }
        ];
# ü¶Ü says ‚Æû automatically add all zigbee devices  
        device.values = let
          reservedNames = [ "hall" "kitchen" "bedroom" "bathroom" "wc" "livingroom" "kitchen" "switch" "all" "every" ];
          sanitize = str:
            lib.replaceStrings [ "/" " " ] [ "" "_" ] str;
        in [
          { "in" = "[living room|livingroom|livingroom|main room|front room]"; out = "livingroom"; }
          { "in" = "[kitchen|cooking area|kitchen area]"; out = "kitchen"; }
          { "in" = "[bedroom|sleeping room|master bedroom]"; out = "bedroom"; }
          { "in" = "[bathroom|restroom|washroom]"; out = "bathroom"; }
          { "in" = "[hallway|hall|corridor|passage]"; out = "hallway"; }
          { "in" = "[all|every|everything|all lights]"; out = "ALL_LIGHTS"; }    
        ] ++
        (lib.filter (x: x != null) (
          lib.mapAttrsToList (_: device:
           let
              baseRaw = lib.toLower device.friendly_name;
              base = sanitize baseRaw;
              baseWords = lib.splitString " " base;
              isAmbiguous = lib.any (word: lib.elem word reservedNames) baseWords;
              hasLampSuffix = lib.hasSuffix "lamp" base;
              lampanVariant = if hasLampSuffix then [ "${base}s" "${base} light" ] else [];  
              enVariant = [ "${base}s" "${base} light" ]; # English variants
              variations = lib.unique (
                [
                  base
                  (sanitize (lib.replaceStrings [ " " ] [ "" ] base))
                  (lib.replaceStrings [ "_" ] [ " " ] base)
                ] ++ lampanVariant ++ enVariant
              );
            in if isAmbiguous then null else {
              "in" = "[" + lib.concatStringsSep "|" variations + "]";
              out = device.friendly_name;
           }
          ) zigbeeDevices
        ));      
        # ü¶Ü says ‚Æû color yo        
        color.values = [
          { "in" = "[red|red color|crimson]"; out = "red"; }
          { "in" = "[green|green color|emerald]"; out = "green"; }
          { "in" = "[blue|blue color|azure]"; out = "blue"; }
          { "in" = "[yellow|yellow color|golden]"; out = "yellow"; }
          { "in" = "[orange|orange color|amber]"; out = "orange"; }
          { "in" = "[purple|purple color|violet]"; out = "purple"; }
          { "in" = "[pink|pink color|rose]"; out = "pink"; }
          { "in" = "[white|white color|pure white]"; out = "white"; }
        ];      
        pair.values = [
          { "in" = "[pair|pairing|discover|scan]"; out = "true"; }
        ];   
</span><span class="clean-version hidden">
  voice = {
      priority = 1;
      sentences = [
        "(turn on|switch on|activate|start|power on) {device}"
        "(turn off|switch off|deactivate|stop|power off) {device}"
        "(turn|switch) {device} {state}"
        "(turn|switch) {state} {device}"
        "{device} {state} and brightness {brightness} percent"
        "{device} {state} with {color} color and {brightness} percent brightness"
        "{device} {state} in {room} and [change] color [to] {color} [and] brightness [to] {brightness} percent"

        "{state} (all|every) light[s] in {room}"
        "{state} {room} light[s]"
        "{state} (all|every) light[s]"
        "{state} (all|every) {device} light[s]"
        "control (all|every) light[s] in {room}"
        "manage {room} lighting"

        "(change|set|adjust) {device} color to {color}"
        "(change|set|adjust) color of {device} to {color}"
        "make {device} {color}"
        "set {device} to {color} color"
        "apply {color} color to {device}"

        "(adjust|set|change) {device} brightness to {brightness} percent"
        "(adjust|set|change) brightness of {device} to {brightness} percent"
        "make {device} {brightness} percent brightness"
        "set {device} to {brightness} percent brightness"
        "dim {device} to {brightness} percent"
        "brighten {device} to {brightness} percent"

        "create {scene} (scene|mode|atmosphere) in {room}"
        "set {room} to {scene} (scene|mode|atmosphere)"
        "activate {scene} mode"

        "set {room} lights to {state} with {color} at {brightness} percent and activate {scene}"
        "{device} {state} in {room} with {color} color at {brightness} percent and temperature {temperature} using scene {scene}"
        "configure {device} in {room} with {color} color, {brightness} percent brightness, and {temperature} temperature"
        "create {scene} atmosphere in {room} using {color} lighting at {brightness} percent [in cheap mode]"
        "adjust all lights in {room} to {color} with {brightness} percent brightness and set {temperature} temperature"

        "{pair} [new] [zigbee] (device|devices|sensor|sensors)"
        "start {pair} [new] device[s]"
        "enable {pair} mode for new devices"
        "begin device {pair}"
      ];                        
      lists = {
        state.values = [
          { "in" = "[t√§nd|t√§nda|t√§nk|start|starta|p√•|t√∂nd|t√∂md]"; out = "ON"; }             
          { "in" = "[sl√§ck|sl√§cka|slick|av|st√§ng|st√§ng av]"; out = "OFF"; } 
        ];
        brightness.values = builtins.genList (i: {
          "in" = toString (i + 1);
          out = toString (i + 1);
        }) 100 ++ [
          { "in" = "[full|maximum|max|hundred]"; out = "100"; }
          { "in" = "[half|fifty|medium]"; out = "50"; }
          { "in" = "[quarter|twenty five|low]"; out = "25"; }
          { "in" = "[ten percent|minimal|dim]"; out = "10"; }
          { "in" = "[five percent|minimum|min]"; out = "5"; }
          { "in" = "[zero|off|dark]"; out = "0"; }
        ]; 
        device.values = let
          reservedNames = [ "hall" "kitchen" "bedroom" "bathroom" "wc" "livingroom" "kitchen" "switch" "all" "every" ];
          sanitize = str:
            lib.replaceStrings [ "/" " " ] [ "" "_" ] str;
        in [
          { "in" = "[living room|livingroom|livingroom|main room|front room]"; out = "livingroom"; }
          { "in" = "[kitchen|cooking area|kitchen area]"; out = "kitchen"; }
          { "in" = "[bedroom|sleeping room|master bedroom]"; out = "bedroom"; }
          { "in" = "[bathroom|restroom|washroom]"; out = "bathroom"; }
          { "in" = "[hallway|hall|corridor|passage]"; out = "hallway"; }
          { "in" = "[all|every|everything|all lights]"; out = "ALL_LIGHTS"; }    
        ] ++
        (lib.filter (x: x != null) (
          lib.mapAttrsToList (_: device:
           let
              baseRaw = lib.toLower device.friendly_name;
              base = sanitize baseRaw;
              baseWords = lib.splitString " " base;
              isAmbiguous = lib.any (word: lib.elem word reservedNames) baseWords;
              hasLampSuffix = lib.hasSuffix "lamp" base;
              lampanVariant = if hasLampSuffix then [ "${base}s" "${base} light" ] else [];  
              enVariant = [ "${base}s" "${base} light" ]; # English variants
              variations = lib.unique (
                [
                  base
                  (sanitize (lib.replaceStrings [ " " ] [ "" ] base))
                  (lib.replaceStrings [ "_" ] [ " " ] base)
                ] ++ lampanVariant ++ enVariant
              );
            in if isAmbiguous then null else {
              "in" = "[" + lib.concatStringsSep "|" variations + "]";
              out = device.friendly_name;
           }
          ) zigbeeDevices
        ));      
                
        color.values = [
          # Basic colors
          { "in" = "[red|red color|crimson]"; out = "red"; }
          { "in" = "[green|green color|emerald]"; out = "green"; }
          { "in" = "[blue|blue color|azure]"; out = "blue"; }
          { "in" = "[yellow|yellow color|golden]"; out = "yellow"; }
          { "in" = "[orange|orange color|amber]"; out = "orange"; }
          { "in" = "[purple|purple color|violet]"; out = "purple"; }
          { "in" = "[pink|pink color|rose]"; out = "pink"; }
          { "in" = "[white|white color|pure white]"; out = "white"; }
        ];
        pair.values = [
          { "in" = "[pair|pairing|discover|scan]"; out = "true"; }
        ];     
</span></pre>
            </div>
        </div>
    </details>        



            <p>Something like that maybe? Sorry English is not my native language.<br>
            But you get the point.<br>
            <br>        
        






            <h2 class="section-title">Full Source Code</h2>
            <a href="https://github.com/QuackHack-McBlindy/dotfiles/blob/main/bin/home/house.nix" class="source-link">
              View source code on GitHub
            </a><br>   



            <h2 class="section-title">Keep Reading</h2>
        
            <a href ="part1.html">Part 1. The module, the options and defining devices</a><br>
            <a href ="part2.html">Part 2. Configure your Mosquitto/Z2MQTT</a><br>
            <a href ="part3.html">Part 3. Nix Configured Automations</a> <br>           
            <a href ="part4.html">Part 4. Writing a Server Service - in Rust</a>  <br> 
            <a href ="part5.html">Part 5. Writing a Client - With Voice Commands</a> <span class="current-marker">‚Æúü¶Ühere u are</span><br>
            <a href ="part6.html">Part 6. The Auto-Generated Dashboard</a><br>        

            <br><br>
    
            

            <section id="comments">
              <h2>Comments on this blog post</h2>
              <script 
                src="https://utteranc.es/client.js"
                repo="QuackHack-McBlindy/blog"
                issue-term="pathname"
                theme="github-light"
                crossorigin="anonymous"
                async>
              </script>
            </section>
        </p>
    </div>



    </div>
    
    <footer>
        <p>All thoughts are my own and should not be considered advice of any kind. More likely the opposite.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const codeBlocks = document.querySelectorAll('details.code-block-container');
            
            codeBlocks.forEach(block => {
                const summary = block.querySelector('summary');
                const codeLang = summary.querySelector('.code-lang');
                const toggleIcon = summary.querySelector('.toggle-icon');
                
                const originalText = codeLang.innerHTML;
                const viewText = originalText.replace('Hide', 'View').replace('‚Æû', '‚Æü');
                const hideText = originalText.replace('View', 'Hide').replace('‚Æü', '‚Æû');
                
                if (block.open) {
                    codeLang.innerHTML = hideText;
                } else {
                    codeLang.innerHTML = viewText;
                }
                
                block.addEventListener('toggle', function() {
                    if (this.open) {
                        codeLang.innerHTML = hideText;
                    } else {
                        codeLang.innerHTML = viewText;
                    }
                });
            });
        });
        document.addEventListener('DOMContentLoaded', function() {
            const duckToggle = document.getElementById('duckToggle');
            let ducksHidden = false;
            
            function toggleCodeDucks() {
                ducksHidden = !ducksHidden;
                
                const duckVersions = document.querySelectorAll('.duck-version');
                const cleanVersions = document.querySelectorAll('.clean-version');
                
                duckVersions.forEach(version => {
                    version.classList.toggle('hidden', ducksHidden);
                });
                
                cleanVersions.forEach(version => {
                    version.classList.toggle('hidden', !ducksHidden);
                });
                
                duckToggle.innerHTML = ducksHidden ? 
                    '<span class="duck-icon"></span> Show ü¶Ü commentary' : 
                    '<span class="duck-icon"></span> Hide ü¶Ü commentary';
                    
                const duckIcon = duckToggle.querySelector('.duck-icon');
                duckIcon.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    duckIcon.style.transform = 'scale(1)';
                }, 300);
            }
            
            duckToggle.addEventListener('click', toggleCodeDucks);
            
            document.querySelectorAll('.clean-version').forEach(version => {
                version.classList.add('hidden');
            });
        });
    </script>
</body>
</html>
